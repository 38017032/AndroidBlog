
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Android 开源项目源码解析之PhotoView 源码解析 | Android博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1. 功能介绍特性(Features)：
支持Pinch手势自由缩放。
支持双击放大/还原。
支持平滑滚动。
在滑动父控件下能够运行良好。（例如：ViewPager）
支持基于Matrix变化（放大/缩小/移动）的事件监听。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 开源项目源码解析之PhotoView 源码解析">
<meta property="og:url" content="http://likebamboo.com/AndroidBlog/2015/05/03/android-open-project-analysis_photoview/index.html">
<meta property="og:site_name" content="Android博客">
<meta property="og:description" content="1. 功能介绍特性(Features)：
支持Pinch手势自由缩放。
支持双击放大/还原。
支持平滑滚动。
在滑动父控件下能够运行良好。（例如：ViewPager）
支持基于Matrix变化（放大/缩小/移动）的事件监听。">
<meta property="og:image" content="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/flow.png">
<meta property="og:image" content="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/startuml.jpg">
<meta property="og:image" content="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/matrix.jpg">
<meta property="og:image" content="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/tranlate.png">
<meta property="og:image" content="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/scale.png">
<meta property="og:image" content="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/rotate.png">
<meta property="og:image" content="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/skew.png">
<meta property="og:updated_time" content="2015-07-11T08:20:35.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 开源项目源码解析之PhotoView 源码解析">
<meta name="twitter:description" content="1. 功能介绍特性(Features)：
支持Pinch手势自由缩放。
支持双击放大/还原。
支持平滑滚动。
在滑动父控件下能够运行良好。（例如：ViewPager）
支持基于Matrix变化（放大/缩小/移动）的事件监听。">
  
    <link rel="alternative" href="/AndroidBlog/atom.xml" title="Android博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="http://likebamboo.com/AndroidBlog/css/style.css" type="text/css">
  <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="http://likebamboo.com/AndroidBlog/" id="logo">Android博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="http://likebamboo.com/AndroidBlog/" id="subtitle">读万卷书</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="http://likebamboo.com/AndroidBlog/index.html">首页</a>
        
          <a class="main-nav-link" href="http://likebamboo.com/AndroidBlog/archives">归档</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/AndroidBlog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="likebamboo.com/AndroidBlog">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="post-android-open-project-analysis_photoview" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="http://likebamboo.com/AndroidBlog/2015/05/03/android-open-project-analysis_photoview/" class="article-date">
  <time datetime="2015-05-02T16:00:00.000Z" itemprop="datePublished">2015-05-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="http://likebamboo.com/AndroidBlog/categories/连载/">连载</a>►<a class="article-category-link" href="http://likebamboo.com/AndroidBlog/categories/连载/开源项目解析/">开源项目解析</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android 开源项目源码解析之PhotoView 源码解析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-_功能介绍">1. 功能介绍</h3><h5 id="特性(Features)：">特性(Features)：</h5><ul>
<li>支持Pinch手势自由缩放。</li>
<li>支持双击放大/还原。</li>
<li>支持平滑滚动。</li>
<li>在滑动父控件下能够运行良好。（例如：ViewPager）</li>
<li>支持基于Matrix变化（放大/缩小/移动）的事件监听。<a id="more"></a>
<h5 id="优势：">优势：</h5></li>
<li>PhotoView是ImageView的子类，自然的支持所有ImageView的源生行为。</li>
<li>任意项目可以非常方便的从ImageView升级到PhotoView，不用做任何额外的修改。</li>
<li>可以非常方便的与ImageLoader/Picasso之类的异步网络图片读取库集成使用。</li>
<li>事件分发做了很好的处理，可以方便的与ViewPager等同样支持滑动手势的控件集成。</li>
</ul>
<h3 id="2-_总体设计">2. 总体设计</h3><p>PhotoView这个库实际上比较简单,关键点其实就是Touch事件处理和Matrix图形变换的应用.</p>
<h5 id="2-1_TouchEvent及手势事件处理">2.1 TouchEvent及手势事件处理</h5><p>对TouchEvent分发流程不了解的建议先阅读 <a href="http://www.trinea.cn/android/touch-event-delivery-mechanism/" target="_blank" rel="external">Android Touch事件传递机制</a></p>
<p>本库中对Touch事件的处理流程请参考第三部分的流程图，会有一个比较直观的认识。</p>
<h5 id="2-2_Matrix">2.2 Matrix</h5><p>由于Matrix是Android系统源生API,很多开发者对此都比较熟悉,为了不影响阅读效果，故不在此详细叙述,如果对其不是很了解,可以查看本文档末尾的Matrix补充说明</p>
<h3 id="3-_流程图">3. 流程图</h3><p>Touch及手势事件判定及传递流程：</p>
<p><img src="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/flow.png" alt="流程图"></p>
<p>如图，从架构上看，干净利落的将事件层层分离，交由不同的Detector处理，最后再将处理结果回调给PhtotViewAttacher中的Matrix去实现图形变换效果。</p>
<h3 id="4-_详细设计">4. 详细设计</h3><h3 id="4-1_核心类功能介绍">4.1 核心类功能介绍</h3><h3 id="Core核心类">Core核心类</h3><hr>
<h5 id="4-1-1_PhotoView">4.1.1 PhotoView</h5><p>PhotoView 类负责暴露所有供外部调用的API,其本身直接继承自ImageView,同时实现了IPhotoView接口.<br>IPhotoView接口提供了缩放相关的设置属性 和操控matrix变化的回调接口.</p>
<p>主要方法说明:</p>
<ul>
<li>public PhotoView(Context context)</li>
<li>public PhotoView(Context context, AttributeSet attr)</li>
<li>public PhotoView(Context context, AttributeSet attr, int defStyle)</li>
</ul>
<p>构造函数,完全与ImageView相同,你可以将PhotoView直接当做ImageView使用,完全兼容.</p>
<ul>
<li>public void setPhotoViewRotation(float rotationDegree)</li>
</ul>
<p>用于设置图片旋转角度.</p>
<p>注意：<br>例如使用Android相机拍摄的相片,会根据拍摄时手机方向的不同,在EXIF中存储不同的旋转角度信息,显示时往往需要查询EXIF信息并将照片旋转至正确的方向.<br>通常我们处理这种问题有两种方案：</p>
<ul>
<li>通过Bitmap.createBitmap方式重建出正确方向的图片，再加载到ImageView中显示。(不建议使用，因为会占用双倍的内存，Bitmap的回收不是立即生效的。)</li>
<li>在ImageView中使用自定义Matrix将图片旋转到正确的方向。</li>
</ul>
<p>由于PhotoView中对图片的 缩放 操作依赖对Matrix的操作，自定义Matrix会干扰 PhotoView 的缩放行为，所以PhotoView并不支持ScaleType.Matrix.<br>可参见PhotoViewAttacher源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span><br><span class="line"> * <span class="doctag">@return</span> true if the ScaleType is supported.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSupportedScaleType</span><span class="params">(<span class="keyword">final</span> ScaleType scaleType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == scaleType) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (scaleType) &#123;</span><br><span class="line">        <span class="keyword">case</span> MATRIX:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(scaleType.name()</span><br><span class="line">                    + <span class="string">" is not supported in PhotoView"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里特意提供了一个额外的setPhotoViewRotation方法即是为了解决这个问题。</p>
<ul>
<li>public boolean canZoom()</li>
<li>public void setZoomable(boolean zoomable) </li>
</ul>
<p>缩放功能开关及状态获取.<br>关闭后PhotoView将不再响应 <code>缩放</code> 动作.</p>
<ul>
<li>public RectF getDisplayRect()</li>
<li>public Matrix getDisplayMatrix()</li>
<li>public boolean setDisplayMatrix(Matrix finalRectangle)</li>
</ul>
<p>获取及设置当前 <code>matrix</code> 状态.</p>
<ul>
<li>public ScaleType getScaleType()</li>
</ul>
<p>获取缩放模式。使用的源生的ImageView.ScaleType.<br>在PhotoView中默认值为FIT_CENTER.</p>
<ul>
<li>public void setAllowParentInterceptOnEdge(boolean allow)</li>
</ul>
<p>设置标志位 是否允许父控件捕获发生在边缘的TouchEvent</p>
<p>这个标志位实际上对应的是<br>ViewParent.requestDisallowInterceptTouchEvent(boolean flag)</p>
<p>经常做自定义View处理TouchEvent的对这个方法应当都不陌生。</p>
<p>PhotoView中英文注释：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* Here we decide whether to let the ImageView's parent to start taking</span><br><span class="line">* over the touch event.</span><br><span class="line">*</span><br><span class="line">* First we<span class="instruction"> check </span>whether this function is enabled. We never want the</span><br><span class="line">* parent to take over<span class="instruction"> if </span>we're scaling. We then<span class="instruction"> check </span>the edge we're</span><br><span class="line">* on,<span class="instruction"> and </span>the direction of the scroll<span class="function"> (</span>i.e.<span class="instruction"> if </span>we're pulling against</span><br><span class="line">* the edge, aka 'overscrolling', let the parent take over<span class="function">)</span>.</span><br></pre></td></tr></table></figure>
<p>对应的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ViewParent parent = imageView.getParent();</span><br><span class="line"><span class="keyword">if</span> (mAllowParentInterceptOnEdge &amp;&amp; !mScaleDragDetector.isScaling()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mScrollEdge == EDGE_BOTH</span><br><span class="line">            || (mScrollEdge == EDGE_LEFT &amp;&amp; dx &gt;= <span class="number">1f</span>)</span><br><span class="line">            || (mScrollEdge == EDGE_RIGHT &amp;&amp; dx &lt;= -<span class="number">1f</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != parent)</span><br><span class="line">            parent.requestDisallowInterceptTouchEvent(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != parent) &#123;</span><br><span class="line">        parent.requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过调用setAllowParentInterceptOnEdge(false),可以完全屏蔽父控件的TouchEvent.<br>这个设置是为了防止父控件响应InterceptTouchEvent.</p>
<p>例如</p>
<p>PhotoView外层是ScrollView,通过requestDisallowInterceptTouchEvent方法可以阻止ScrollView响应滑动手势.</p>
<p>PhotoView本身已做好了相关处理,在PhotoView滚到图片边缘时,Scroll事件由父控件处理,在PhotoView未滚动到边缘时,Scroll事件由PhotoView处理.</p>
<p>除非开发者有特殊的需求,否则不需要自己去调用该方法改变TouchEvent事件的阻断逻辑.</p>
<ul>
<li>public void setImageDrawable(Drawable drawable)</li>
<li>public void setImageResource(int resId) </li>
<li>public void setImageURI(Uri uri)</li>
</ul>
<p>重载了ImageView的3个设置图片的方法,以确保图片改变时PhotoViewAttacher及时更新视图和重置matrix状态</p>
<ul>
<li>protected void onDetachedFromWindow()</li>
</ul>
<p>重载了ImageView的方法,用于在视图被从Window中移除时,通知PhotoViewAttacher清空数据.</p>
<h5 id="4-1-2_IPhotoView">4.1.2 IPhotoView</h5><p>IPhotoView接口定义了缩放相关的一组set/get方法.PhotoView是其实现类.<br>相关方法已在PhotoView中介绍,这里略过.</p>
<h5 id="4-1-3_PhotoViewAttacher">4.1.3 PhotoViewAttacher</h5><p>核心类</p>
<ul>
<li>private static boolean isSupportedScaleType(final ScaleType scaleType) </li>
</ul>
<p>判断ScaleType是否支持。<br>这个判断中实际只有ScaleType.Matrix会返回false.</p>
<p>由于PhotoView中 缩放 滑动操作都依赖<code>Matrix</code>,所以并不支持用户再传入自定义Matrix.</p>
<ul>
<li>public void cleanup()</li>
</ul>
<p>PhotoView不再使用时,可用于释放相关资源。移除Observer, Listener.</p>
<ul>
<li>public boolean setDisplayMatrix(Matrix finalMatrix)</li>
</ul>
<p>通过Matrix来直接修改ImageView的显示状态。</p>
<ul>
<li>private void cancelFling()</li>
</ul>
<p>取消惯性滑动。</p>
<ul>
<li>private boolean checkMatrixBounds() </li>
</ul>
<p>检查当前显示范围是否处于边界上，并更新mScrollEdge标志位。</p>
<p>处理TouchEvent时需要根据mScrollEdge标志位的状态来判断是否允许ViewParent的InterceptTouchEvent接收TouchEvent.</p>
<ul>
<li>private void resetMatrix()</li>
</ul>
<p>重置Matrix状态，并恢复至FIT_CENTER状态</p>
<ul>
<li>private void updateBaseMatrix(Drawable d)</li>
</ul>
<p>根据PhotoView的宽高和Drawable的宽高计算FIT_CENTER状态的Matrix.</p>
<ul>
<li>public void onDrag(float dx, float dy)</li>
</ul>
<p>OnGestureListener接口回调的实现方法.</p>
<p>实际完成拖拽/移动效果.<br>核心代码:</p>
<pre><code>mSuppMatrix.postTranslate(<span class="number">dx</span>, <span class="pseudo">dy</span>)<span class="comment">;</span>
</code></pre><p>通过改代码修改Matrix中View的起始位置,制造出图片被拖拽移动的效果.</p>
<ul>
<li>public void onFling(float startX, float startY, float velocityX, float velocityY)</li>
</ul>
<p>OnGestureListener接口回调的实现方法.<br>实际完成惯性滑动效果.</p>
<p>惯性滑动效果分两部分完成.</p>
<p>1) 调用 </p>
<pre><code>mScroller.fling(startX, startY, velocityX, velocityY, <span class="keyword">min</span>X,
                    <span class="keyword">max</span>X, <span class="keyword">min</span>Y, <span class="keyword">max</span>Y, <span class="number">0</span>, <span class="number">0</span>);
</code></pre><p>进行惯性滑动辅助计算.</p>
<p>对Scroller不了解的可以参考官方说明 <a href="http://developer.android.com/reference/android/widget/Scroller.html" target="_blank" rel="external">Scroller</a></p>
<p>简单来讲,Scroller是一个辅助计算器,它可以帮你计算出某一时刻View的滚动状态及位置,但是它本身不会对View进行任何更改</p>
<p>2) 使用了FlingRunnable和Compat.postOnAnimation(imageView,mFlingRunnable)在每一帧绘制前更新Matrix状态<br>关于FlingRunnable和Compat.postOnAnimation类的作用机制可以参考下面 4.1.4的说明.</p>
<ul>
<li>public void onScale(float scaleFactor, float focusX, float focusY)</li>
</ul>
<p>OnGestureListener接口回调的实现方法.</p>
<p>实际完成缩放效果.</p>
<p>核心代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSuppMatrix.postScale(scaleFactor, scaleFactor, focusX, focusY);</span><br></pre></td></tr></table></figure>
<p>对Matrix作用机制不了解的话,可以拉到文档最后,有一个针对Matrix的简略介绍.</p>
<h6 id="内部类_FlingRunnable">内部类 FlingRunnable</h6><p>实现惯性滑动的动画效果.</p>
<p>这个Runnable必须配合 View.postOnAnimation(view,runnable) 使用.</p>
<p>在下一帧绘制前,系统会执行该Runnable,这样我们就可以在runnable中更新UI状态.</p>
<p>原理上类似一个递归调用,每次UI绘制前更新UI状态,并指定下次UI更新前再执行自己.</p>
<p>这种写法 与 使用循环或Handler每隔16ms刷新一次UI基本等价,但是更为方便快捷.</p>
<p>更新UI的核心逻辑非常简单,根据mScroller计算出的偏移量更新Matrix状态:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSuppMatrix.postTranslate(dx, dy);</span><br></pre></td></tr></table></figure>
<h6 id="内部类_AnimatedZoomRunnable">内部类 AnimatedZoomRunnable</h6><p>实现双击时的 缩放动画.</p>
<p>作用机制基本同上.</p>
<p>区别是AnimatedZoomRunnable的执行进度由AccelerateDecelerateInterpolator控制.</p>
<p>对Interpolator没有概念的可以参阅官方Demo<br><a href="http://developer.android.com/samples/Interpolator/src/com.example.android.interpolator/InterpolatorFragment.html" target="_blank" rel="external">Interpolator</a></p>
<p>你也可以简单认为这就是一个动画进度控制器.</p>
<p>核心逻辑依然很简单,根据动画进度缩小/放大图片</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSuppMatrix.postScale(deltaScale, deltaScale, mFocalX, mFocalY);</span><br></pre></td></tr></table></figure>
<h3 id="接口及工具类">接口及工具类</h3><hr>
<h5 id="4-1-4_Compat">4.1.4 Compat</h5><p>用于做View.postOnAnimation方法在低版本上的兼容.</p>
<p>注：View.postOnAnimation (Runnable action) 在PhotoView中用于处理  双击 放大/缩小 惯性滑动时的动画效果.</p>
<p>每次系统绘图前都会先执行这个Runnable回调，通过在此时改变视图状态以实现动画效果。该方法仅支持 api &gt;= 16<br>所以PhotoView中使用了Compat类来做低版本兼容。</p>
<p>实际上也可以使用android.support.v4.view.ViewCompat替代。<br>对比 android.support.v4.view.ViewCompat 和 uk.co.senab.photoview.Compat<br>其实现原理完全一致，都是通过view.postDelayed(runnable, frameTime)来实现.</p>
<h5 id="4-1-5_ScrollerProxy">4.1.5 ScrollerProxy</h5><p>抽象类,主要是为了做不用版本之间的兼容,具体说明见<code>GingerScroller</code> <code>IcsScroller</code> <code>PreGingerScroller</code> 这三个接口实现类的说明.</p>
<h5 id="4-1-6_GingerScroller">4.1.6 GingerScroller</h5><p><code>ScrollerProxy</code> 接口实现类<br>适用于 API 9 ~ 14 即 2.3 ~ 4.0 之间的所有Android版本.<br>其实现主要基于 android.widget.OverScroller</p>
<h5 id="4-1-7_IcsScroller">4.1.7 IcsScroller</h5><p>适用于 API 14 以上 即 4.0 以上的所有Android版本<br>其实现基于源生 android.widget.OverScroller , 没有任何修改.</p>
<h5 id="4-1-8_PreGingerScroller">4.1.8 PreGingerScroller</h5><p>适用于 API 9 以下 即 2.3 以下的所有Android版本<br>其实现主要基于 android.widget.Scroller</p>
<h5 id="4-1-9_GestureDetector">4.1.9 GestureDetector</h5><p>接口,主要是为了做不同版本之间的兼容,具体说明见 <code>CupcakeGestureDetector</code>,<code>EclairGestureDetector</code>,<code>FroyoGestureDetector</code> 三个接口的实现类.</p>
<h5 id="4-1-10_OnGestureListener">4.1.10 OnGestureListener</h5><p>手势回调接口</p>
<h5 id="4-1-11_CupcakeGestureDetector">4.1.11 CupcakeGestureDetector</h5><p>适用于 api &lt; 7 的设备,此时PhotoView不支持双指pinch放大/缩小操作</p>
<h5 id="4-1-12_EclairGestureDetector">4.1.12 EclairGestureDetector</h5><p>适用于 api &gt;= 8 , 用于修正多指操控的问题,使TouchEvent的getActiveX getActiveY指向正确的Pointer,并将事件传递给 <code>CupcakeGestureDetector</code> 处理,此时PhotoView不支持双指pinch放大/缩小操作</p>
<h5 id="4-1-13_FroyoGestureDetector">4.1.13 FroyoGestureDetector</h5><p>适用于 api &gt; 9 , 通过android.view.ScaleGestureDetector实现对Pinch手势的支持,并将事件传递给 <code>EclairGestureDetector</code> 处理</p>
<p>注意:<br>以上3个类并不实际执行 放大/缩小 行为, 判断行为之后会回调给PhtotViewAttacher执行缩放/移动操作</p>
<h5 id="4-1-14_VersionedGestureDetector">4.1.14 VersionedGestureDetector</h5><p>提供GestureDetector的实例，由它根据系统版本决定实例化哪一个 GestureDetector ，主要是为了兼容Android的不同版本。<br>具体调用栈请参考总体设计中调用流程图,注意一点,PhotoViewAttacher本身就实现了OnGestureListener接口,实际的缩放操作是由PhotoViewAttacher完成的,而不是这里声明的各个GestureDetector.</p>
<h3 id="4-2_类关系图">4.2 类关系图</h3><p><img src="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/startuml.jpg" alt="PhotoView"></p>
<h3 id="5-_杂谈">5. 杂谈</h3><p>该库唯一缺少的可能是 手势旋转 功能(可以参考QQ). 不过由于PhotoView中已将各级事件分开处理,从架构上来看可扩展性良好,自定义一个RotateGestureDetector来捕获旋转手势也可行.<br>但如何在不与ScaleGestureDetector冲突的情况下完成该功能会稍微有些麻烦.<br>如果不需要手势旋转的话，该库提供了单独的接口可以用代码设置旋转角度。</p>
<h3 id="6-_Matrix补充说明">6. Matrix补充说明</h3><p>Matrix是一个 3x3 矩阵,使用Matrix可以对 Bitmap/Canvas 进行4类基本图形变换,使用起来非常简便，如果你对Matrix的抽象变换不熟悉，还可以使用android.graphics.Camera类进行辅助计算。<br>Camera类可以将矩阵变换抽象成 视点（摄像机） 在三维空间内的移动，更易于直观的理解其效果。</p>
<p>矩阵如下：</p>
<p><img src="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/matrix.jpg" alt="tranlate"></p>
<p>相关API使用起来非常简单。<br>效果用文字比较难表述，直接看图好了.<br>你也可以自己运行<a href="https://github.com/android-cn/android-open-project-demo/tree/master/photoview-demo/MatrixDemo" target="_blank" rel="external">Demo Project</a></p>
<p>虚影为原始位置，实图为变换后位置.</p>
<h4 id="API">API</h4><ul>
<li><p>public void setTranslate(float dx, float dy)</p>
<p>  对目标进行平移dx,dy</p>
<p>  <img src="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/tranlate.png" alt="tranlate"></p>
</li>
<li><p>public void setScale(float sx, float sy, float px, float py)</p>
<p>  以(px,py)为中心,横向上缩放比例sx,纵向缩放比例sy</p>
<p>  <img src="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/scale.png" alt="scale"></p>
</li>
<li><p>public void setRotate(float degrees, float px, float py)</p>
<p>  以(px,py)为中心,旋转degrees度</p>
<p>  <img src="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/rotate.png" alt="rotate"></p>
</li>
<li><p>public void setSkew(float kx, float ky, float px, float py)</p>
<p>  图像的错切实际上是平面景物在投影平面上的非垂直投影。错切使图像中的图形产生扭变。<br>  这里是以(px,py)为中心,扭曲图片的x轴和y轴.</p>
<p>  这个用文字难以解释,请参考下面的实际效果图片.</p>
<p>  <img src="https://github.com/android-cn/android-open-project-analysis/raw/master/photoview/images/skew.png" alt="skew"></p>
</li>
</ul>
<h4 id="原理">原理</h4><p>如果你对矩阵变换背后的数学原理感兴趣且<code>线性代数</code>的内容没忘光的话，推荐这篇 <a href="http://www.cnblogs.com/qiengo/archive/2012/06/30/2570874.html" target="_blank" rel="external">文章</a>.</p>
<blockquote>
<p>本文为 <a href="https://github.com/android-cn/android-open-project-analysis" target="_blank" rel="external">Android 开源项目源码解析</a> 中 PhotoView 部分<br>项目地址：<a href="https://github.com/chrisbanes/PhotoView" target="_blank" rel="external">PhotoView</a>，分析的版本：<a href="https://github.com/chrisbanes/PhotoView/commit/48427bff9bb1a408cfebf6697aa019c0788ded76" target="_blank" rel="external">48427bf</a>，Demo 地址：<a href="https://github.com/android-cn/android-open-project-demo/tree/master/photoview-demo" target="_blank" rel="external">PhotoView-demo</a><br>分析者：<a href="https://github.com/dkmeteor" target="_blank" rel="external">dkmeteor</a>，校对者：<a href="https://github.com/cpacm" target="_blank" rel="external">cpacm</a>，校对状态：完成   </p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://likebamboo.com/AndroidBlog/2015/05/03/android-open-project-analysis_photoview/" data-id="cibyx170i00a8sw1i86ey620s" class="article-share-link" data-share="baidu">分享到</a>
      

      
        <a href="http://likebamboo.com/AndroidBlog/2015/05/03/android-open-project-analysis_photoview/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/开源项目解析/">开源项目解析</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="http://likebamboo.com/AndroidBlog/2015/05/03/android-open-project-analysis_universal-image-loader/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">
        
          Android 开源项目源码解析之Universal Image Loader 源码分析
        
      </div>
    </a>
  
  
    <a href="http://likebamboo.com/AndroidBlog/2015/05/03/android-open-project-analysis_event-bus/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">Android 开源项目源码解析之EventBus 源码解析</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="ds-thread" class="ds-thread" data-thread-key="2015/05/03/android-open-project-analysis_photoview/" data-title="Android 开源项目源码解析之PhotoView 源码解析" data-url="http://likebamboo.com/AndroidBlog/2015/05/03/android-open-project-analysis_photoview/"></div>
  </section>
</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/AndroidIDE/">AndroidIDE</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/Android架构/">Android架构</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/Reactive-Extension-RX/">Reactive Extension(RX)</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/单元测试/">单元测试</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/性能优化/">性能优化</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/翻译/">翻译</a><span class="category-list-count">64</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/翻译/Android架构/">Android架构</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/翻译/单元测试/">单元测试</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/翻译/材料设计/">材料设计</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/翻译/自动化测试/">自动化测试</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/翻译/连载/">连载</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/自动化测试/">自动化测试</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/设计模式/">设计模式</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/连载/">连载</a><span class="category-list-count">16</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="http://likebamboo.com/AndroidBlog/categories/连载/开源项目解析/">开源项目解析</a><span class="category-list-count">15</span></li></ul></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/Android-Studio/">Android Studio</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/AndroidStudio/">AndroidStudio</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/Android架构/">Android架构</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/AppCompat/">AppCompat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/AsyncTask/">AsyncTask</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/Builder模式/">Builder模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/CodeReview/">CodeReview</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/Drawables/">Drawables</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/MVP/">MVP</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/MVVM/">MVVM</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/Proxy模式/">Proxy模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/RxJava-RxAndroid/">RxJava/RxAndroid</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/Support-Library/">Support Library</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/SupportLibrary/">SupportLibrary</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/主题/">主题</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/任务调度/">任务调度</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/依赖注入/">依赖注入</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/内存泄露/">内存泄露</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/动画/">动画</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/单例模式/">单例模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/原型模式/">原型模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/图形管道/">图形管道</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/图片缓存/">图片缓存</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/基础/">基础</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/外观模式/">外观模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/多进程/">多进程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/字体/">字体</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/小技巧/">小技巧</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/工具/">工具</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/开源库介绍/">开源库介绍</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/开源项目解析/">开源项目解析</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/性能优化/">性能优化</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/拍照/">拍照</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/材料设计/">材料设计</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/桥接模式/">桥接模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/模板方法模式/">模板方法模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/测试/">测试</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/特效/">特效</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/策略模式/">策略模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/网络请求/">网络请求</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/翻译/">翻译</a><span class="tag-list-count">42</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/自动化/">自动化</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/视频/">视频</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/责任链模式/">责任链模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/连载/">连载</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="http://likebamboo.com/AndroidBlog/tags/迭代器模式/">迭代器模式</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="http://likebamboo.com/AndroidBlog/archives/2015/06/">六月 2015</a><span class="archive-list-count">20</span></li><li class="archive-list-item"><a class="archive-list-link" href="http://likebamboo.com/AndroidBlog/archives/2015/05/">五月 2015</a><span class="archive-list-count">63</span></li><li class="archive-list-item"><a class="archive-list-link" href="http://likebamboo.com/AndroidBlog/archives/2015/04/">四月 2015</a><span class="archive-list-count">28</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://likebamboo.com/AndroidBlog/2015/06/14/android-design-support-library/">Android Design Support Library</a>
          </li>
        
          <li>
            <a href="http://likebamboo.com/AndroidBlog/2015/06/14/android-design-support-library-part-1-navigation-view/">Design Support Library (I)-Navigation View</a>
          </li>
        
          <li>
            <a href="http://likebamboo.com/AndroidBlog/2015/06/14/mvvm-on-android-what-you-need-to-know/">MVVM 模式简介</a>
          </li>
        
          <li>
            <a href="http://likebamboo.com/AndroidBlog/2015/06/14/introduction-to-webRTC-on-android/">Android之WebRTC介绍</a>
          </li>
        
          <li>
            <a href="http://likebamboo.com/AndroidBlog/2015/06/11/google-developing-for-android-part-6/">Google Developing for Android 系列6</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 likebamboo<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="http://likebamboo.com/AndroidBlog/index.html" class="mobile-nav-link">首页</a>
  
    <a href="http://likebamboo.com/AndroidBlog/archives" class="mobile-nav-link">归档</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="返回顶部"><img src="http://likebamboo.com/AndroidBlog/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"likebamboo"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>window._bd_share_config={"common":{},"share":{"bdCustomStyle":"http://likebamboo.com/AndroidBlog/css/bdshare.css"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<script src="http://likebamboo.com/AndroidBlog/js/script.js" type="text/javascript"></script>

</div>
</body>
</html>
